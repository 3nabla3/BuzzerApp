<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/x-icon" href="/static/buzzer.jpg">
    <title>Buzzer app</title>
</head>
<body>

<button type="button" id="change-user" onclick="logout()">Change username</button>
<button type="button" id="reset-button" onclick="resetBuzzer()">Reset button</button>

<button type="button" id="buzzer" onclick="buzzerClick()">
    {{ request.cookies.get('user') }}
</button>

<script>
    {% if g.clicked != None %}
    // start prep
        {% if g.clicked != request.cookies['user'] %}
            failure("{{ g.clicked }}");
        {% else %}
            success();
        {% endif %}
    // end prep
    {% endif %}

    function failure(user) {
        console.log("failure");
        document.getElementById("buzzer").innerHTML =
            "Too late! " + user + " already pressed the button";
    }

    function success() {
        console.log("success");
        document.getElementById("buzzer").innerHTML =
            "You pressed the button!";
    }

    function resetBuzzerText() {
        document.getElementById("buzzer").innerHTML = "{{ request.cookies['user'] }}"
    }

    function logout() {
        console.log('logging out!');
        let xhr = new XMLHttpRequest();
        xhr.open('POST', '{{ url_for('logout') }}')
        xhr.send();

        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4)
                window.location.reload();
        }
    }

    function buzzerClick() {
        console.log('buzzer clicked!');
        let xhr = new XMLHttpRequest();
        xhr.open('POST', '{{ url_for('click') }}')

        xhr.setRequestHeader('Accept', 'application/json');
        xhr.setRequestHeader('Content-Type', 'application/json');

        xhr.onreadystatechange = function () {
            let resp = xhr.responseText;
            if (xhr.readyState === 4) {
                console.log(resp);
                if (resp === "pressed")
                    document.getElementById("buzzer").innerHTML = "You pressed the button!"
                else if (resp !== "{{ request.cookies['user'] }}")
                    failure(resp)
                else
                    success();
            }
        }
        xhr.send();
    }

    function resetBuzzer() {
        console.log('button reset!');
        let xhr = new XMLHttpRequest();
        xhr.open('POST', '{{ url_for('reset') }}')

        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                console.log(xhr.responseText);
                if (xhr.responseText === "reset") {
                    resetBuzzerText();
                }
            }
        }
        xhr.send();
    }

</script>
</body>
</html>
