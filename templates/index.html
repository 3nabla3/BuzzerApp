<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/x-icon" href="/static/buzzer.jpg">
    <title>Buzzer app</title>
</head>
<body>

<button type="button" id="change-user" onclick="logout()">Change username</button>
<button type="button" id="reset-button" onclick="resetBuzzer()">Reset button</button>

<button type="button" id="buzzer" onclick="buzzerClick()">
    {{ request.cookies.get('user') }}
</button>

<script>
    let clicked = false;

    {% if g.clicked != None %}
        // start prep
        {% if g.clicked != request.cookies['user'] %}
            failure("{{ g.clicked }}");
        {% else %}
            success();
        {% endif %}
        // end prep
    {% endif %}

    waitForClick();

    function failure(user) {
        console.log("failure: " + user);
        document.getElementById("buzzer").innerHTML =
            "Too late! " + user + " already pressed the button";
        clicked = true;
    }

    function success() {
        console.log("success");
        document.getElementById("buzzer").innerHTML =
            "You pressed the button!";
    }

    function resetBuzzerText() {
        console.log("reset buzzer text");
        document.getElementById("buzzer").innerHTML = "{{ request.cookies['user'] }}"
        clicked = false;
    }

    function logout() {
        console.log('logging out!');

        let xhr = new XMLHttpRequest();
        xhr.open('POST', '{{ url_for('logout') }}')

        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4)
                window.location.reload();
        }

        xhr.send();
    }

    function buzzerClick() {
        if (clicked) return;
        clicked = true;

        console.log('buzzer clicked!');
        let xhr = new XMLHttpRequest();
        xhr.open('POST', '{{ url_for('click') }}')

        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                let resp = xhr.responseText;
                console.log("resp: " + resp);
                if (resp === "pressed")
                    success();
                else
                    failure(resp);
            }
        }
        xhr.send();
    }

    function resetBuzzer() {
        console.log('button reset!');
        let xhr = new XMLHttpRequest();
        xhr.open('POST', '{{ url_for('reset') }}')

        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                console.log(xhr.responseText);
                if (xhr.responseText === "reset")
                    resetBuzzerText();
            }
        }
        xhr.send();
    }

    function waitForClick() {
        console.log("wait for click");

        let xhr = new XMLHttpRequest();
        xhr.open('POST', "{{ url_for('wait_buzz') }}");

        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                console.log("Someone buzzed!!");
                let resp = xhr.responseText;
                if (resp !== "{{ request.cookies['user'] }}" && resp !== "")
                    failure(resp);
                waitForReset();
            }
        }

        xhr.send();
    }

    function waitForReset() {
        console.log("wait for reset");

        let xhr = new XMLHttpRequest();
        xhr.open('POST', "{{ url_for('wait_reset') }}");

        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                if (xhr.responseText === "reset")
                    resetBuzzerText();
                waitForClick();
            }
        }
        xhr.send();
    }

</script>
</body>
</html>
